<%- include("header") %>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Coupons</h2>
            <p>Add, edit, or delete a coupon</p>
        </div>
        <!-- <div>
            <input type="text" placeholder="Search Categories" class="form-control bg-white">
        </div> -->
    </div>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <% if (message) { %>
                        <div id="successMessage" class="alert alert-success text-center mt-5" role="alert">
                            <%= message %>
                        </div>
                    <% } %>
                    <% if (errMessage) { %>
                        <div id="errorMessage" class="alert alert-danger text-center mt-5" role="alert">
                            <%= errMessage %>
                        </div>
                    <% } %>
                    <!-- Coupon creation form -->
                    <form method="post" onsubmit="return createCouponValidation()" action="/admin/coupons" id="createCouponForm">
                      <div class="mb-4">
                        <label for="coupon_id" class="form-label">Coupon ID</label>
                        <input type="text" placeholder="Type here" name="coupon_id" class="form-control" id="coupon_id">
                        <div id="couponIdError" class="text-danger"></div> <!-- Error message element for Coupon ID -->
                      </div>
                      <div class="mb-4">
                          <label for="limit" class="form-label">Limit</label>
                          <input placeholder="Type here" name="limit" class="form-control" id="limit">
                          <div id="limitError" class="text-danger"></div> <!-- Error message element for Limit -->
                      </div>
                      <div class="mb-4" style="display: none;" id="expiry_Date_Div">
                          <label for="expiry_Date" class="form-label">Expiry Date</label>
                          <input type="text" placeholder="Type here" name="expiry_Date" class="form-control" id="expiry_Date">
                          <div id="expiryDateError" class="text-danger"></div> <!-- Error message element for Expiry Date -->
                      </div>
                    

                      <div class="mb-4">
                        <label for="minimum_Amount" class="form-label">Minimum Amount</label>
                        <input placeholder="Type here" name="minimum_Amount" class="form-control" id="minimum_Amount">
                        <div id="minimumAmountError" class="text-danger"></div> <!-- Error message element for Minimum Amount -->
                      </div>
                      <div class="mb-4">
                          <label for="maximum_Discount" class="form-label">Maximum Discount</label>
                          <input placeholder="Type here" name="maximum_Discount" class="form-control" id="maximum_Discount">
                          <div id="maximumDiscountError" class="text-danger"></div> <!-- Error message element for Maximum Discount -->
                      </div>
                      <div class="mb-4">
                          <label for="discount_Percentage" class="form-label">Discount Percentage</label>
                          <input placeholder="Type here" name="discount_Percentage" class="form-control" id="discount_Percentage">
                          <div id="discountPercentageError" class="text-danger"></div> <!-- Error message element for Discount Percentage -->
                      </div>
                                          
                      <div class="d-grid" id="coupon_btn">
                        <button type="submit" class="btn btn-primary" id="createCouponBtn">Create Coupon</button>

                        <button type="submit" class="btn btn-primary" id="editCouponBtn" style="display: none;">Edit Coupon</button>
                                                  
                      </div>
                  </form>
                  

                </div>
                <div class="col-md-9">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Coupon ID</th>
                                    <th>Edit</th>
                                    <th>View Details</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% coupons.forEach(function(coupon) { %>
                                    <tr>
                                        <td>
                                            <%= coupon.coupon_id %>
                                        </td>
                                        <td>
                                              <button class="btn btn-light rounded btn-sm font-sm"
                                              onclick="editCoupon('<%= coupon._id %>', '<%= coupon.coupon_id %>', '<%= coupon.limit %>', '<%= coupon.expiry_Date %>', '<%= coupon.minimum_Amount %>', '<%= coupon.maximum_Discount %>', '<%= coupon.discount_Percentage %>')">Edit</button>
                                        </td>
                                        <td>
                                          <button class="btn btn-info rounded btn-sm font-sm"
                                          onclick="viewDetails('<%= coupon._id %>', '<%= coupon.coupon_id %>', '<%= coupon.limit %>', '<%= coupon.expiry_Date %>', '<%= coupon.minimum_Amount %>', '<%= coupon.maximum_Discount %>', '<%= coupon.discount_Percentage %>')">View Details</button>
                                        </td>
                                        <td>
                                            <% if (coupon.valid) { %>
                                                <button class="btn btn-success rounded btn-sm font-sm"
                                                    onclick="toggleBlockUnblock('<%= coupon._id %>', false)">Unblock</button>
                                            <% } else { %>
                                                <!-- Block Button -->
                                                <button class="btn btn-danger rounded btn-sm font-sm"
                                                    onclick="toggleBlockUnblock('<%= coupon._id %>', true)">Block</button>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div> <!-- .col// -->
            </div> <!-- .row // -->
        </div> <!-- card body .// -->
    </div> <!-- card .// -->
</section>

<!-- JavaScript code to handle form submission and editing -->
<script>
function editCoupon(couponId, coupon_id, limit, expiry_Date, minimum_Amount, maximum_Discount, discount_Percentage) {
    // Set values in the coupon creation form for editing
    document.getElementById('coupon_id').value = coupon_id;
    document.getElementById('limit').value = limit;
    document.getElementById('minimum_Amount').value = minimum_Amount;
    document.getElementById('maximum_Discount').value = maximum_Discount;
    document.getElementById('discount_Percentage').value = discount_Percentage;
    document.getElementById('expiry_Date').value = expiry_Date;
    // Toggle button visibility
    document.getElementById('expiry_Date_Div').style.display = 'block';
    document.getElementById('createCouponBtn').style.display = 'none';
    document.getElementById('editCouponBtn').style.display = 'block';

    // Update the form action to include couponId for editing
    document.getElementById('createCouponForm').action = `/admin/editCoupon/${couponId}`;
}

function viewDetails(couponId, coupon_id, limit, expiry_Date, minimum_Amount, maximum_Discount, discount_Percentage) {
    // Display details in input fields
    document.getElementById('coupon_id').value = coupon_id;
    document.getElementById('limit').value = limit;
    document.getElementById('expiry_Date').value = expiry_Date;
    document.getElementById('minimum_Amount').value = minimum_Amount;
    document.getElementById('maximum_Discount').value = maximum_Discount;
    document.getElementById('discount_Percentage').value = discount_Percentage;

    // Toggle button visibility back to "Create Coupon" button
    document.getElementById('expiry_Date_Div').style.display = 'block';
    document.getElementById('createCouponBtn').style.display = 'none';
    document.getElementById('editCouponBtn').style.display = 'none';
}
  
  function toggleBlockUnblock(categoryId, blockStatus) {
      fetch(`/admin/toggleBlockStatus/${categoryId}`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({ blocked: blockStatus })
      })
      .then(response => {
          if (response.ok) {
              location.reload(); // Reload the page to reflect the updated status
          } else {
              alert('Failed to toggle block status');
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while toggling block status');
      });
  }

  function createCouponValidation() {
   // Input fields
   const couponId = document.getElementById('coupon_id');
   const limit = document.getElementById('limit');
   const expiryDate = document.getElementById('expiry_Date');
   const minimumAmount = document.getElementById('minimum_Amount');
   const maximumDiscount = document.getElementById('maximum_Discount');
   const discountPercentage = document.getElementById('discount_Percentage');

   // Error fields
   const couponIdError = document.getElementById('couponIdError');
   const limitError = document.getElementById('limitError');
   const expiryDateError = document.getElementById('expiryDateError');
   const minimumAmountError = document.getElementById('minimumAmountError');
   const maximumDiscountError = document.getElementById('maximumDiscountError');
   const discountPercentageError = document.getElementById('discountPercentageError');

   // Regex
   const idRegex = /^[A-Z][A-Za-z0-9]*$/; // Coupon ID starts with an uppercase letter and can include letters and numbers.
   const numericRegex = /^\d+$/; // Numeric input (e.g., limit, minimumAmount, maximumDiscount, discountPercentage).
   const dateRegex = /^\d{2}-\d{2}-\d{4}$/; // DD-MM-YYYY format for expiry date.

   let isValid = true; // A flag to track overall validation

   // Function to clear error message with a delay
   function clearErrorWithDelay(errorField) {
      setTimeout(() => {
         errorField.innerHTML = '';
      }, 5000); // 5000 milliseconds = 5 seconds
   }

   // Function to validate coupon ID
   function validateCouponId() {
      if (couponId.value.trim() === '') {
         couponIdError.innerHTML = 'Coupon ID cannot be empty';
         clearErrorWithDelay(couponIdError);
         isValid = false;
      } else if (!idRegex.test(couponId.value)) {
         couponIdError.innerHTML = 'Coupon ID should start with a capital letter and can include letters and numbers';
         clearErrorWithDelay(couponIdError);
         isValid = false;
      } else {
         couponIdError.innerHTML = ''; // Clear error message
      }
   }

   // Function to validate numeric fields
   function validateNumericField(field, fieldError, fieldName) {
      if (field.value.trim() === '') {
         fieldError.innerHTML = `${fieldName} cannot be empty`;
         clearErrorWithDelay(fieldError);
         isValid = false;
      } else if (!numericRegex.test(field.value)) {
         fieldError.innerHTML = `Please enter a valid ${fieldName}`;
         clearErrorWithDelay(fieldError);
         isValid = false;
      } else {
         fieldError.innerHTML = ''; // Clear error message
      }
   }

   // Function to validate expiry date
   function validateExpiryDate() {
      if (expiryDate.value.trim() === '') {
         expiryDateError.innerHTML = 'Expiry Date cannot be empty';
         clearErrorWithDelay(expiryDateError);
         isValid = false;
      } else if (!dateRegex.test(expiryDate.value)) {
         expiryDateError.innerHTML = 'Please enter a valid expiry date in DD-MM-YYYY format';
         clearErrorWithDelay(expiryDateError);
         isValid = false;
      } else {
         expiryDateError.innerHTML = ''; // Clear error message
      }
   }

   // Validate fields one by one
   validateCouponId();
   if (isValid) validateNumericField(limit, limitError, 'Limit');
   if (isValid) validateNumericField(minimumAmount, minimumAmountError, 'Minimum Amount');
   if (isValid) validateNumericField(maximumDiscount, maximumDiscountError, 'Maximum Discount');
   if (isValid) validateNumericField(discountPercentage, discountPercentageError, 'Discount Percentage');
   if (isValid) validateExpiryDate();

   return isValid;
}


</script>

<%- include("footer") %>
